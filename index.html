<!DOCTYPE html>
<html>
<head>
    <title>音声認識</title>
    <style>
        #status {
            padding: 1em;
            color: white;
            display: inline-block;
            margin-left: 10px;
        }
        .remove {
            cursor: pointer;
            color: red;
            margin-left: 10px;
        }
        .remove:before {
            content: "\00D7";
        }
    </style>
</head>
<body>
    <button id="start">音声認識を開始</button>
    <button id="stop">音声認識を停止</button>
    <div id="status" class="waiting">待機中</div>
    <select id="language">
        <option value="ja-JP">日本語</option>
        <option value="en-US">英語</option>
    </select>
    <input type="text" id="filter" placeholder="フィルタ..." />
    <ul id="log"></ul>
    <script>
        let isContinuous = false;
        const startButton = document.querySelector('#start');
        const stopButton = document.querySelector('#stop');
        const statusBox = document.querySelector('#status');
        const languageSelector = document.querySelector('#language');
        const filterInput = document.querySelector('#filter');
        const logArea = document.querySelector('#log');

        // SpeechRecognition インスタンスを生成
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();

        recognition.interimResults = true;  // 結果がまだ確定しない状態でも取得する
        recognition.maxAlternatives = 1;  // 候補の数

        recognition.onstart = () => {
            statusBox.textContent = '音声認識中...';
            statusBox.style.backgroundColor = 'green';
        };

        recognition.onend = () => {
            statusBox.textContent = '待機中';
            statusBox.style.backgroundColor = 'red';
            if (isContinuous) {
                recognition.start();
            }
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';  // 中間結果
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    const li = document.createElement('li');
                    li.textContent = transcript;

                    // Remove button
                    const removeBtn = document.createElement('span');
                    removeBtn.className = 'remove';
                    removeBtn.onclick = () => { li.remove(); };

                    li.appendChild(removeBtn);
                    logArea.appendChild(li);  // ログに追加
                } else {
                    interimTranscript += transcript;
                }
            }
        };

        // 音声認識を開始・停止するイベントを設定
        startButton.onclick = () => {
            recognition.lang = languageSelector.value;  // 言語設定
            isContinuous = true;
            recognition.start();
        };
        stopButton.onclick = () => { 
            isContinuous = false;
            recognition.stop();
        };

        // フィルタリング機能
        filterInput.oninput = () => {
            const filterValue = filterInput.value;
            for (let li of logArea.children) {
                if (li.textContent.includes(filterValue)) {
                    li.style.display = '';
                } else {
                    li.style.display = 'none';
                }
            }
        };
    </script>
</body>
</html>
